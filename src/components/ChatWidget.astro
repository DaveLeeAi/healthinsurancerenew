---
import chatRouting from '../data/chat-routing.json';
import config from '../data/config.json';
---
<div id="chat-widget" class="fixed bottom-6 right-6 z-50">
  <button
    id="chat-toggle"
    class="w-14 h-14 rounded-full bg-primary-600 text-white shadow-lg hover:bg-primary-700 hover:shadow-xl transition-all duration-200 flex items-center justify-center"
    aria-label="Open help assistant"
  >
    <svg id="chat-icon-open" class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 10h.01M12 10h.01M16 10h.01M9 16H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-5l-5 5v-5z"/>
    </svg>
    <svg id="chat-icon-close" class="w-6 h-6 hidden" fill="none" stroke="currentColor" viewBox="0 0 24 24">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
    </svg>
  </button>

  <div id="chat-panel" class="hidden absolute bottom-18 right-0 w-80 sm:w-96 max-h-[32rem] bg-white rounded-2xl shadow-2xl border border-neutral-200 overflow-hidden flex flex-col">
    <div class="bg-primary-600 text-white px-5 py-4">
      <p class="font-semibold text-sm">Site Guide</p>
      <p class="text-xs text-primary-100 mt-0.5">Find the right resource for your question</p>
    </div>

    <div id="chat-body" class="flex-1 overflow-y-auto p-4 space-y-3">
      <div id="chat-categories" class="grid grid-cols-2 gap-2">
        {chatRouting.categories.map((cat) => (
          <button
            class="chat-category-btn text-left p-3 rounded-lg border border-neutral-200 hover:border-primary-300 hover:bg-primary-50 transition-all duration-150 text-sm font-medium text-neutral-700"
            data-category={cat.id}
          >
            {cat.label}
          </button>
        ))}
      </div>

      <div id="chat-response" class="hidden">
        <button id="chat-back" class="text-xs text-primary-600 hover:text-primary-800 mb-3 flex items-center gap-1 transition-colors">
          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/>
          </svg>
          Back to topics
        </button>
        <p id="chat-response-text" class="text-sm text-neutral-700 mb-3"></p>
        <div id="chat-response-links" class="space-y-2"></div>
        <div id="chat-state-picker" class="hidden mt-3">
          <select id="chat-state-select" class="w-full rounded-lg border border-neutral-300 px-3 py-2 text-sm focus:ring-2 focus:ring-primary-500 focus:border-primary-500 outline-none">
            <option value="">Select your state...</option>
          </select>
          <a id="chat-state-link" href="#" class="hidden mt-2 block text-center px-4 py-2 rounded-lg bg-primary-600 text-white text-sm font-medium hover:bg-primary-700 transition-colors">
            View state info
          </a>
        </div>
      </div>

      <div class="pt-2 border-t border-neutral-100 mt-3">
        <a
          href={chatRouting.handoverUrl}
          class="flex items-center justify-center gap-2 w-full px-4 py-2.5 rounded-lg border-2 border-primary-200 text-primary-700 text-sm font-medium hover:bg-primary-50 transition-colors"
        >
          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/>
          </svg>
          {chatRouting.handoverText}
        </a>
      </div>
    </div>

    <div class="bg-neutral-50 px-4 py-2.5 border-t border-neutral-200">
      <p class="text-[10px] text-neutral-500 leading-relaxed">
        {chatRouting.disclaimer}
      </p>
    </div>
  </div>
</div>

<script define:vars={{ categories: chatRouting.categories, states: config.licensedStates }}>
  const toggle = document.getElementById('chat-toggle');
  const panel = document.getElementById('chat-panel');
  const iconOpen = document.getElementById('chat-icon-open');
  const iconClose = document.getElementById('chat-icon-close');
  const categoriesDiv = document.getElementById('chat-categories');
  const responseDiv = document.getElementById('chat-response');
  const responseText = document.getElementById('chat-response-text');
  const responseLinks = document.getElementById('chat-response-links');
  const backBtn = document.getElementById('chat-back');
  const statePicker = document.getElementById('chat-state-picker');
  const stateSelect = document.getElementById('chat-state-select');
  const stateLink = document.getElementById('chat-state-link');

  toggle?.addEventListener('click', () => {
    panel?.classList.toggle('hidden');
    iconOpen?.classList.toggle('hidden');
    iconClose?.classList.toggle('hidden');
  });

  backBtn?.addEventListener('click', () => {
    categoriesDiv?.classList.remove('hidden');
    responseDiv?.classList.add('hidden');
  });

  document.querySelectorAll('.chat-category-btn').forEach((btn) => {
    btn.addEventListener('click', () => {
      const catId = btn.getAttribute('data-category');
      const cat = categories.find((c) => c.id === catId);
      if (!cat) return;

      categoriesDiv?.classList.add('hidden');
      responseDiv?.classList.remove('hidden');

      if (responseText) responseText.textContent = cat.response;

      if (responseLinks) {
        responseLinks.innerHTML = '';
        cat.links.forEach((link) => {
          const a = document.createElement('a');
          a.href = link.url;
          a.className = 'block px-3 py-2 rounded-lg bg-primary-50 text-primary-700 text-sm hover:bg-primary-100 transition-colors';
          a.textContent = link.title;
          responseLinks.appendChild(a);
        });
      }

      if (cat.isStatePicker) {
        statePicker?.classList.remove('hidden');
        if (stateSelect && stateSelect.children.length <= 1) {
          states.forEach((s) => {
            const opt = document.createElement('option');
            opt.value = s.slug;
            opt.textContent = `${s.name} (${s.abbr})`;
            stateSelect.appendChild(opt);
          });
        }
      } else {
        statePicker?.classList.add('hidden');
      }
    });
  });

  stateSelect?.addEventListener('change', (e) => {
    const slug = e.target.value;
    if (slug && stateLink) {
      stateLink.href = `/states/${slug}`;
      stateLink.classList.remove('hidden');
    } else if (stateLink) {
      stateLink.classList.add('hidden');
    }
  });
</script>
