---
import chatRouting from '../data/chat-routing.json';
import config from '../data/config.json';
---
<div id="chat-widget">
  <button
    id="chat-toggle"
    class="fixed bottom-6 right-6 z-50 w-14 h-14 rounded-2xl bg-primary-600 text-white shadow-lg hover:bg-primary-700 hover:shadow-xl transition-all duration-200 flex items-center justify-center"
    aria-label="Open site librarian"
  >
    <svg id="chat-icon-open" class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M12 6.042A8.967 8.967 0 006 3.75c-1.052 0-2.062.18-3 .512v14.25A8.987 8.987 0 016 18c2.305 0 4.408.867 6 2.292m0-14.25a8.966 8.966 0 016-2.292c1.052 0 2.062.18 3 .512v14.25A8.987 8.987 0 0018 18a8.967 8.967 0 00-6 2.292m0-14.25v14.25"/>
    </svg>
    <svg id="chat-icon-close" class="w-6 h-6 hidden" fill="none" stroke="currentColor" viewBox="0 0 24 24">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
    </svg>
  </button>

  <div id="chat-overlay" class="hidden fixed inset-0 z-50 bg-slate-950/30 backdrop-blur-sm transition-opacity"></div>

  <div id="chat-panel" class="fixed top-0 right-0 z-50 h-full w-full sm:w-[420px] translate-x-full transition-transform duration-300 ease-out flex flex-col bg-white/95 backdrop-blur-xl border-l border-slate-200/60 shadow-2xl">
    <div class="bg-gradient-to-r from-slate-900 to-primary-800 text-white px-6 py-5 flex items-center justify-between shrink-0">
      <div>
        <p class="font-semibold text-base">Site Librarian</p>
        <p class="text-sm text-slate-200 mt-0.5">Find the right resource for your question</p>
      </div>
      <button id="chat-close" class="p-2 rounded-lg hover:bg-white/10 transition-colors" aria-label="Close librarian">
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
        </svg>
      </button>
    </div>

    <div id="chat-body" class="flex-1 overflow-y-auto p-6 space-y-4">
      <div id="chat-categories" class="grid grid-cols-2 gap-3">
        {chatRouting.categories.map((cat) => (
          <button
            class="chat-category-btn text-left p-4 rounded-xl bg-white/70 backdrop-blur-sm border border-slate-200/80 hover:border-primary-300 hover:bg-white hover:shadow-lg transition-all duration-200 text-sm font-medium text-slate-700"
            data-category={cat.id}
          >
            <span class="block text-slate-900 font-semibold">{cat.label}</span>
          </button>
        ))}
      </div>

      <div id="chat-response" class="hidden">
        <button id="chat-back" class="text-sm text-primary-600 hover:text-primary-800 mb-4 flex items-center gap-1 transition-colors font-medium">
          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/>
          </svg>
          Back to topics
        </button>
        <p id="chat-response-text" class="text-sm text-slate-700 mb-4 leading-relaxed"></p>
        <div id="chat-response-links" class="space-y-2"></div>
        <div id="chat-state-picker" class="hidden mt-4">
          <select id="chat-state-select" class="w-full rounded-xl border border-slate-200 bg-white/70 backdrop-blur-sm px-4 py-3 text-sm focus:ring-2 focus:ring-primary-500 focus:border-primary-500 outline-none">
            <option value="">Select your state...</option>
          </select>
          <a id="chat-state-link" href="#" class="hidden mt-3 block text-center px-4 py-2.5 rounded-xl bg-primary-600 text-white text-sm font-medium hover:bg-primary-700 transition-colors">
            View state info
          </a>
        </div>
      </div>
    </div>

    <div class="shrink-0 p-6 border-t border-slate-200/60 space-y-3">
      <a
        href={chatRouting.handoverUrl}
        class="flex items-center justify-center gap-2 w-full px-4 py-3 rounded-xl border-2 border-primary-200 text-primary-700 text-sm font-semibold hover:bg-primary-50 transition-colors"
      >
        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/>
        </svg>
        {chatRouting.handoverText}
      </a>
      <p class="text-[10px] text-slate-500 leading-relaxed text-center">
        {chatRouting.disclaimer}
      </p>
    </div>
  </div>
</div>

<script define:vars={{ categories: chatRouting.categories, states: config.licensedStates }}>
  const toggle = document.getElementById('chat-toggle');
  const panel = document.getElementById('chat-panel');
  const overlay = document.getElementById('chat-overlay');
  const closeBtn = document.getElementById('chat-close');
  const iconOpen = document.getElementById('chat-icon-open');
  const iconClose = document.getElementById('chat-icon-close');
  const categoriesDiv = document.getElementById('chat-categories');
  const responseDiv = document.getElementById('chat-response');
  const responseText = document.getElementById('chat-response-text');
  const responseLinks = document.getElementById('chat-response-links');
  const backBtn = document.getElementById('chat-back');
  const statePicker = document.getElementById('chat-state-picker');
  const stateSelect = document.getElementById('chat-state-select');
  const stateLink = document.getElementById('chat-state-link');

  function openPanel() {
    panel?.classList.remove('translate-x-full');
    panel?.classList.add('translate-x-0');
    overlay?.classList.remove('hidden');
    iconOpen?.classList.add('hidden');
    iconClose?.classList.remove('hidden');
    document.body.style.overflow = 'hidden';
  }

  function closePanel() {
    panel?.classList.remove('translate-x-0');
    panel?.classList.add('translate-x-full');
    overlay?.classList.add('hidden');
    iconOpen?.classList.remove('hidden');
    iconClose?.classList.add('hidden');
    document.body.style.overflow = '';
  }

  toggle?.addEventListener('click', () => {
    const isOpen = panel?.classList.contains('translate-x-0');
    if (isOpen) { closePanel(); } else { openPanel(); }
  });

  closeBtn?.addEventListener('click', closePanel);
  overlay?.addEventListener('click', closePanel);

  backBtn?.addEventListener('click', () => {
    categoriesDiv?.classList.remove('hidden');
    responseDiv?.classList.add('hidden');
  });

  document.querySelectorAll('.chat-category-btn').forEach((btn) => {
    btn.addEventListener('click', () => {
      const catId = btn.getAttribute('data-category');
      const cat = categories.find((c) => c.id === catId);
      if (!cat) return;

      categoriesDiv?.classList.add('hidden');
      responseDiv?.classList.remove('hidden');

      if (responseText) responseText.textContent = cat.response;

      if (responseLinks) {
        responseLinks.innerHTML = '';
        cat.links.forEach((link) => {
          const a = document.createElement('a');
          a.href = link.url;
          a.className = 'block px-4 py-3 rounded-xl bg-white/70 backdrop-blur-sm border border-slate-200/80 text-primary-700 text-sm font-medium hover:bg-white hover:shadow-md hover:border-primary-300 transition-all duration-200';
          a.textContent = link.title;
          responseLinks.appendChild(a);
        });
      }

      if (cat.isStatePicker) {
        statePicker?.classList.remove('hidden');
        if (stateSelect && stateSelect.children.length <= 1) {
          states.forEach((s) => {
            const opt = document.createElement('option');
            opt.value = s.slug;
            opt.textContent = `${s.name} (${s.abbr})`;
            stateSelect.appendChild(opt);
          });
        }
      } else {
        statePicker?.classList.add('hidden');
      }
    });
  });

  stateSelect?.addEventListener('change', (e) => {
    const slug = e.target.value;
    if (slug && stateLink) {
      stateLink.href = `/states/${slug}`;
      stateLink.classList.remove('hidden');
    } else if (stateLink) {
      stateLink.classList.add('hidden');
    }
  });
</script>
