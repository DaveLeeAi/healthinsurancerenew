---
import { getEntry, render } from 'astro:content';
import BaseLayout from '../../layouts/BaseLayout.astro';
import Breadcrumbs from '../../components/Breadcrumbs.astro';
import AnswerBox from '../../components/AnswerBox.astro';
import Disclaimer from '../../components/Disclaimer.astro';
import FAQSection from '../../components/FAQSection.astro';
import LastUpdated from '../../components/LastUpdated.astro';
import AuthorBio from '../../components/AuthorBio.astro';
import SourcesBox from '../../components/SourcesBox.astro';
import { getBreadcrumbSchema, getArticleSchema, getFAQSchema, getSoftwareApplicationSchema } from '../../lib/schema';
import affordabilityData from '../../data/affordability-threshold.json';

const entry = await getEntry('tools', 'job-plan-affordability');
const { Content } = await render(entry);
const { title, description, datePublished, dateModified, faqs } = entry.data;

const breadcrumbs = [
  { name: 'Home', url: '/' },
  { name: 'Tools', url: '/tools' },
  { name: 'Job Plan Affordability', url: '/tools/job-plan-affordability' },
];

const schemas = [
  getBreadcrumbSchema(breadcrumbs),
  getArticleSchema({ title, description, url: '/tools/job-plan-affordability', datePublished, dateModified }),
  getSoftwareApplicationSchema({ name: title, description, url: '/tools/job-plan-affordability' }),
  ...(faqs?.length ? [getFAQSchema(faqs)] : []),
].filter(Boolean);
---

<BaseLayout title={title} description={description} schemas={schemas}>
  <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 py-10">
    <Breadcrumbs items={breadcrumbs} />

    <h1 class="text-3xl sm:text-4xl font-bold text-neutral-900 leading-heading mb-4">{title}</h1>

    <AnswerBox answer="Enter your household income and employee-only monthly premium to see whether your employer plan may meet the ACA affordability standard. This is an educational estimate only." />

    <Disclaimer variant="tool" />

    <div class="bg-neutral-50 border border-neutral-200 rounded-lg p-4 mb-6">
      <p class="text-sm text-neutral-600 leading-relaxed">
        This website is not affiliated with any federal or state government agency. Information provided here is for educational purposes only.
      </p>
    </div>

    <!-- Calculator UI -->
    <div class="bg-white rounded-xl border border-neutral-200 p-6 shadow-sm mb-8">
      <h2 class="text-xl font-semibold text-neutral-800 mb-2">Employer Plan Affordability Check</h2>
      <p class="text-sm text-neutral-600 mb-5">
        The ACA affordability threshold for <span id="threshold-year">{affordabilityData.year}</span> is <strong id="threshold-display">{affordabilityData.thresholdPercent}%</strong> of household income for employee-only coverage.
      </p>

      <form id="affordability-form" class="space-y-5">
        <div>
          <label for="household-income" class="block text-sm font-medium text-neutral-700 mb-1">Annual Household Income ($)</label>
          <input
            type="number"
            id="household-income"
            placeholder="e.g. 55000"
            min="0"
            step="100"
            class="w-full rounded-lg border border-neutral-300 px-4 py-2.5 text-sm focus:ring-2 focus:ring-primary-500 focus:border-primary-500 outline-none"
          />
        </div>

        <div>
          <label for="monthly-premium" class="block text-sm font-medium text-neutral-700 mb-1">Monthly Employee-Only Premium ($)</label>
          <input
            type="number"
            id="monthly-premium"
            placeholder="e.g. 350"
            min="0"
            step="1"
            class="w-full rounded-lg border border-neutral-300 px-4 py-2.5 text-sm focus:ring-2 focus:ring-primary-500 focus:border-primary-500 outline-none"
          />
          <p class="text-xs text-neutral-500 mt-1">Enter the cost for the lowest-cost employee-only plan offered by the employer.</p>
        </div>

        <div class="flex gap-3">
          <button
            type="submit"
            class="px-6 py-2.5 rounded-lg bg-primary-600 text-white font-medium hover:bg-primary-700 transition-colors"
          >
            Check Affordability
          </button>
          <button
            type="button"
            id="reset-btn"
            class="px-6 py-2.5 rounded-lg border border-neutral-300 text-neutral-700 font-medium hover:bg-neutral-50 transition-colors"
          >
            Reset
          </button>
        </div>
      </form>

      <!-- Results (hidden by default) -->
      <div id="results" class="hidden mt-6 border-t border-neutral-200 pt-6">
        <h3 class="text-lg font-semibold text-neutral-800 mb-4">Educational Estimate</h3>

        <div class="grid grid-cols-1 sm:grid-cols-3 gap-4 mb-4">
          <div class="bg-neutral-50 rounded-lg p-4">
            <p class="text-sm text-neutral-600 font-medium">Annual Premium</p>
            <p id="result-annual-premium" class="text-xl font-bold text-neutral-900 mt-1">--</p>
          </div>
          <div class="bg-neutral-50 rounded-lg p-4">
            <p class="text-sm text-neutral-600 font-medium">Premium as % of Income</p>
            <p id="result-percent" class="text-xl font-bold text-neutral-900 mt-1">--</p>
          </div>
          <div class="bg-neutral-50 rounded-lg p-4">
            <p class="text-sm text-neutral-600 font-medium">ACA Threshold</p>
            <p id="result-threshold" class="text-xl font-bold text-neutral-900 mt-1">--</p>
          </div>
        </div>

        <div id="result-determination" class="rounded-lg p-4 mb-4">
          <p id="determination-title" class="font-semibold text-lg mb-1">--</p>
          <p id="determination-text" class="text-sm leading-relaxed">--</p>
        </div>

        <p class="text-xs text-neutral-500 mt-4">
          This is a general educational estimate. Actual affordability determinations are made by the Health Insurance Marketplace based on verified information. Multiple factors beyond the premium percentage can affect eligibility for marketplace coverage and subsidies.
        </p>
      </div>
    </div>

    <!-- Content from collection -->
    <div class="prose prose-neutral max-w-none mb-8">
      <Content />
    </div>

    <LastUpdated date={dateModified} />

    {faqs?.length > 0 && <FAQSection faqs={faqs} />}

    <SourcesBox sources={[
      { title: 'IRS - Employer Shared Responsibility Provisions', url: 'https://www.irs.gov/affordable-care-act/employers/employer-shared-responsibility-provisions' },
      { title: 'Healthcare.gov - Employer Coverage Affordability', url: 'https://www.healthcare.gov/have-job-based-coverage/' },
      { title: 'IRS Revenue Procedure - Affordability Percentage', url: 'https://www.irs.gov/affordable-care-act/affordable-care-act-tax-provisions' },
    ]} />

    <AuthorBio />
  </div>
</BaseLayout>

<script define:vars={{ affordabilityData }}>
  document.addEventListener('DOMContentLoaded', function () {
    var form = document.getElementById('affordability-form');
    var resultsDiv = document.getElementById('results');
    var resetBtn = document.getElementById('reset-btn');
    var threshold = affordabilityData.thresholdPercent;

    form.addEventListener('submit', function (e) {
      e.preventDefault();

      var incomeVal = document.getElementById('household-income').value;
      var premiumVal = document.getElementById('monthly-premium').value;

      if (!incomeVal || !premiumVal) {
        alert('Please complete all fields before calculating.');
        return;
      }

      var income = parseFloat(incomeVal);
      var monthlyPremium = parseFloat(premiumVal);

      if (income <= 0) {
        alert('Please enter a valid income amount greater than zero.');
        return;
      }

      if (monthlyPremium < 0) {
        alert('Please enter a valid premium amount.');
        return;
      }

      var annualPremium = monthlyPremium * 12;
      var premiumPercent = (annualPremium / income) * 100;

      document.getElementById('result-annual-premium').textContent = '$' + annualPremium.toLocaleString();
      document.getElementById('result-percent').textContent = premiumPercent.toFixed(2) + '%';
      document.getElementById('result-threshold').textContent = threshold + '%';

      var determinationDiv = document.getElementById('result-determination');
      var determinationTitle = document.getElementById('determination-title');
      var determinationText = document.getElementById('determination-text');

      if (premiumPercent > threshold) {
        determinationDiv.className = 'rounded-lg p-4 mb-4 bg-amber-50 border border-amber-200';
        determinationTitle.className = 'font-semibold text-lg mb-1 text-amber-800';
        determinationTitle.textContent = 'This plan may not meet the ACA affordability standard';
        determinationText.className = 'text-sm leading-relaxed text-amber-700';
        determinationText.textContent =
          'Based on the information provided, the employee-only premium represents ' +
          premiumPercent.toFixed(2) + '% of household income, which exceeds the ' +
          threshold + '% affordability threshold. When an employer plan exceeds this threshold, ' +
          'household members may be able to explore marketplace coverage with potential premium tax credits. ' +
          'This is an educational estimate and not a formal determination.';
      } else {
        determinationDiv.className = 'rounded-lg p-4 mb-4 bg-green-50 border border-green-200';
        determinationTitle.className = 'font-semibold text-lg mb-1 text-green-800';
        determinationTitle.textContent = 'This plan appears to meet the ACA affordability standard';
        determinationText.className = 'text-sm leading-relaxed text-green-700';
        determinationText.textContent =
          'Based on the information provided, the employee-only premium represents ' +
          premiumPercent.toFixed(2) + '% of household income, which is at or below the ' +
          threshold + '% affordability threshold. When an employer plan is considered affordable under ACA guidelines, ' +
          'household members offered that coverage generally may not be eligible for marketplace premium tax credits. ' +
          'This is an educational estimate and not a formal determination.';
      }

      resultsDiv.classList.remove('hidden');
    });

    resetBtn.addEventListener('click', function () {
      form.reset();
      resultsDiv.classList.add('hidden');
    });
  });
</script>
