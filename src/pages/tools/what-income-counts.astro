---
import { getEntry, render } from 'astro:content';
import BaseLayout from '../../layouts/BaseLayout.astro';
import Breadcrumbs from '../../components/Breadcrumbs.astro';
import AnswerBox from '../../components/AnswerBox.astro';
import Disclaimer from '../../components/Disclaimer.astro';
import FAQSection from '../../components/FAQSection.astro';
import LastUpdated from '../../components/LastUpdated.astro';
import AuthorBio from '../../components/AuthorBio.astro';
import SourcesBox from '../../components/SourcesBox.astro';
import { getBreadcrumbSchema, getArticleSchema, getFAQSchema, getSoftwareApplicationSchema } from '../../lib/schema';

const entry = await getEntry('tools', 'what-income-counts');
const { Content } = await render(entry);
const { title, description, datePublished, dateModified, faqs } = entry.data;

const breadcrumbs = [
  { name: 'Home', url: '/' },
  { name: 'Tools', url: '/tools' },
  { name: 'What Income Counts?', url: '/tools/what-income-counts' },
];

const schemas = [
  getBreadcrumbSchema(breadcrumbs),
  getArticleSchema({ title, description, url: '/tools/what-income-counts', datePublished, dateModified }),
  getSoftwareApplicationSchema({ name: title, description, url: '/tools/what-income-counts' }),
  ...(faqs?.length ? [getFAQSchema(faqs)] : []),
].filter(Boolean);
---

<BaseLayout title={title} description={description} schemas={schemas}>
  <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 py-10">
    <Breadcrumbs items={breadcrumbs} />

    <h1 class="text-3xl sm:text-4xl font-bold text-slate-900 leading-heading mb-4">{title}</h1>

    <AnswerBox answer="The marketplace uses a specific income number called MAGI to decide your savings. Enter your income details below to see what yours might be." />

    <Disclaimer variant="tool" />

    <div class="bg-white/70 backdrop-blur-sm border border-slate-200/80 rounded-2xl p-4 mb-6">
      <p class="text-sm text-slate-600 leading-relaxed">
        This website is not affiliated with any federal or state government agency. Information provided here is for educational purposes only.
      </p>
    </div>

    <!-- Calculator UI -->
    <div class="bg-white/70 backdrop-blur-sm rounded-2xl border border-slate-200/80 p-6 shadow-lg mb-8">
      <h2 class="text-xl font-semibold text-slate-800 mb-2">MAGI Estimator</h2>
      <p class="text-sm text-slate-600 mb-5">
        MAGI for ACA purposes is generally calculated as Adjusted Gross Income (AGI) plus certain add-back items. Enter the amounts below to see an educational estimate.
      </p>

      <form id="magi-form" class="space-y-5">
        <div>
          <label for="agi" class="block text-sm font-medium text-slate-700 mb-1">Adjusted Gross Income (AGI) ($)</label>
          <input
            type="number"
            id="agi"
            placeholder="e.g. 50000"
            min="0"
            step="100"
            class="w-full rounded-lg border border-slate-300 px-4 py-2.5 text-sm focus:ring-2 focus:ring-primary-500 focus:border-primary-500 outline-none"
          />
          <p class="text-xs text-slate-500 mt-1">Found on IRS Form 1040, line 11. Includes wages, salary, self-employment income, retirement distributions, investment income, and other taxable income minus above-the-line deductions.</p>
        </div>

        <div class="border-t border-slate-200 pt-5">
          <p class="text-sm font-medium text-slate-800 mb-3">Add-Back Items (if applicable)</p>

          <div class="space-y-4">
            <div>
              <label for="tax-exempt-interest" class="block text-sm font-medium text-slate-700 mb-1">Tax-Exempt Interest Income ($)</label>
              <input
                type="number"
                id="tax-exempt-interest"
                placeholder="0"
                min="0"
                step="1"
                class="w-full rounded-lg border border-slate-300 px-4 py-2.5 text-sm focus:ring-2 focus:ring-primary-500 focus:border-primary-500 outline-none"
              />
              <p class="text-xs text-slate-500 mt-1">Interest from municipal bonds or other tax-exempt sources (Form 1040, line 2a).</p>
            </div>

            <div>
              <label for="foreign-income" class="block text-sm font-medium text-slate-700 mb-1">Excluded Foreign Earned Income ($)</label>
              <input
                type="number"
                id="foreign-income"
                placeholder="0"
                min="0"
                step="1"
                class="w-full rounded-lg border border-slate-300 px-4 py-2.5 text-sm focus:ring-2 focus:ring-primary-500 focus:border-primary-500 outline-none"
              />
              <p class="text-xs text-slate-500 mt-1">Income excluded under the Foreign Earned Income Exclusion (Form 2555).</p>
            </div>

            <div>
              <label for="ss-benefits" class="block text-sm font-medium text-slate-700 mb-1">Non-Taxable Social Security Benefits ($)</label>
              <input
                type="number"
                id="ss-benefits"
                placeholder="0"
                min="0"
                step="1"
                class="w-full rounded-lg border border-slate-300 px-4 py-2.5 text-sm focus:ring-2 focus:ring-primary-500 focus:border-primary-500 outline-none"
              />
              <p class="text-xs text-slate-500 mt-1">The non-taxable portion of Social Security benefits. Total benefits (Form SSA-1099) minus the taxable amount on Form 1040.</p>
            </div>
          </div>
        </div>

        <div id="form-error" class="hidden rounded-lg bg-error-50 border border-error-200 px-4 py-2.5 text-sm text-error-700" role="alert" aria-live="polite"></div>

        <div class="flex gap-3">
          <button
            type="submit"
            class="px-6 py-2.5 rounded-xl bg-navy-900 text-white font-medium hover:bg-navy-800 transition-colors"
          >
            Estimate MAGI
          </button>
          <button
            type="button"
            id="reset-btn"
            class="px-6 py-2.5 rounded-lg border border-slate-300 text-slate-700 font-medium hover:bg-slate-50 transition-colors"
          >
            Reset
          </button>
        </div>
      </form>

      <!-- Results (hidden by default) -->
      <div id="results" class="hidden mt-6 border-t border-slate-200 pt-6">
        <h3 class="text-lg font-semibold text-slate-800 mb-4">Educational Estimate</h3>

        <div class="space-y-3 mb-4">
          <div class="flex justify-between items-center py-2 border-b border-slate-100">
            <span class="text-sm text-slate-600">Adjusted Gross Income (AGI)</span>
            <span id="result-agi" class="text-sm font-semibold text-slate-800">--</span>
          </div>
          <div class="flex justify-between items-center py-2 border-b border-slate-100">
            <span class="text-sm text-slate-600">+ Tax-Exempt Interest</span>
            <span id="result-interest" class="text-sm font-semibold text-slate-800">--</span>
          </div>
          <div class="flex justify-between items-center py-2 border-b border-slate-100">
            <span class="text-sm text-slate-600">+ Excluded Foreign Income</span>
            <span id="result-foreign" class="text-sm font-semibold text-slate-800">--</span>
          </div>
          <div class="flex justify-between items-center py-2 border-b border-slate-100">
            <span class="text-sm text-slate-600">+ Non-Taxable Social Security</span>
            <span id="result-ss" class="text-sm font-semibold text-slate-800">--</span>
          </div>
          <div class="flex justify-between items-center py-3 bg-primary-50/80 backdrop-blur-sm rounded-xl px-3">
            <span class="text-sm font-semibold text-primary-700">Estimated MAGI</span>
            <span id="result-magi" class="text-xl font-bold text-primary-900">--</span>
          </div>
        </div>

        <div id="result-context" class="bg-white/70 backdrop-blur-sm border border-slate-200/80 rounded-xl p-4 mb-4">
          <p class="text-sm text-slate-700 font-medium mb-2">What This Means for ACA Purposes</p>
          <p id="context-text" class="text-sm text-slate-600 leading-relaxed">--</p>
        </div>

        <div class="bg-amber-50/80 backdrop-blur-sm border border-amber-200/80 rounded-xl p-4">
          <p class="text-sm text-amber-800 leading-relaxed">
            <strong>Tax Disclaimer:</strong> This calculator provides a simplified educational estimate of MAGI. Actual MAGI calculations can involve additional complexities depending on individual tax situations. This tool does not constitute tax advice. Consult a qualified tax professional or visit IRS.gov for guidance specific to your circumstances.
          </p>
        </div>

        <p class="text-xs text-slate-500 mt-4">
          This estimate is for educational purposes only. The Health Insurance Marketplace uses verified tax information to determine actual MAGI for subsidy eligibility.
        </p>
      </div>
    </div>

    <!-- Content from collection -->
    <div class="prose prose-neutral max-w-none mb-8 prose-headings:font-bold prose-headings:text-slate-900 prose-a:text-primary-600 hover:prose-a:text-primary-800 font-serif">
      <Content />
    </div>

    <LastUpdated date={dateModified} />

    {faqs?.length > 0 && <FAQSection faqs={faqs} />}

    <SourcesBox sources={[
      { title: 'Healthcare.gov - Income and Household Information', url: 'https://www.healthcare.gov/income-and-household-information/income/' },
      { title: 'IRS - Modified Adjusted Gross Income (MAGI)', url: 'https://www.irs.gov/e-file-providers/definition-of-adjusted-gross-income' },
      { title: 'IRS - Premium Tax Credit Eligibility', url: 'https://www.irs.gov/affordable-care-act/individuals-and-families/premium-tax-credit' },
    ]} />

    <AuthorBio />
  </div>
</BaseLayout>

<script>
  document.addEventListener('DOMContentLoaded', function () {
    var form = document.getElementById('magi-form');
    var resultsDiv = document.getElementById('results');
    var resetBtn = document.getElementById('reset-btn');

    var errorDiv = document.getElementById('form-error');

    function showError(msg) {
      errorDiv.textContent = msg;
      errorDiv.classList.remove('hidden');
    }

    function hideError() {
      errorDiv.classList.add('hidden');
    }

    function formatCurrency(amount) {
      return '$' + amount.toLocaleString();
    }

    form.addEventListener('submit', function (e) {
      e.preventDefault();
      hideError();

      var agiVal = document.getElementById('agi').value;

      if (!agiVal) {
        showError('Please enter your Adjusted Gross Income (AGI).');
        return;
      }

      var agi = parseFloat(agiVal) || 0;
      var taxExemptInterest = parseFloat(document.getElementById('tax-exempt-interest').value) || 0;
      var foreignIncome = parseFloat(document.getElementById('foreign-income').value) || 0;
      var ssBenefits = parseFloat(document.getElementById('ss-benefits').value) || 0;

      var magi = agi + taxExemptInterest + foreignIncome + ssBenefits;

      document.getElementById('result-agi').textContent = formatCurrency(agi);
      document.getElementById('result-interest').textContent = formatCurrency(taxExemptInterest);
      document.getElementById('result-foreign').textContent = formatCurrency(foreignIncome);
      document.getElementById('result-ss').textContent = formatCurrency(ssBenefits);
      document.getElementById('result-magi').textContent = formatCurrency(magi);

      var contextText = '';
      var addBacks = taxExemptInterest + foreignIncome + ssBenefits;

      if (addBacks > 0) {
        contextText = 'Your estimated MAGI of ' + formatCurrency(magi) + ' includes ' +
          formatCurrency(addBacks) + ' in add-back items beyond your AGI. ' +
          'These add-backs are types of income that are not included in AGI on a standard tax return but are counted for ACA subsidy eligibility purposes. ';
      } else {
        contextText = 'Your estimated MAGI of ' + formatCurrency(magi) + ' is the same as your AGI because no add-back items were entered. ' +
          'For many households, MAGI and AGI are the same amount. ';
      }

      contextText += 'The ACA uses MAGI to determine eligibility for premium tax credits and cost-sharing reductions. ' +
        'Generally, MAGI between 100% and 400% of the Federal Poverty Level may indicate eligibility for financial assistance, ' +
        'and under current extended subsidy provisions, assistance may be available at higher income levels as well.';

      document.getElementById('context-text').textContent = contextText;
      resultsDiv.classList.remove('hidden');
    });

    resetBtn.addEventListener('click', function () {
      form.reset();
      resultsDiv.classList.add('hidden');
      hideError();
    });
  });
</script>
