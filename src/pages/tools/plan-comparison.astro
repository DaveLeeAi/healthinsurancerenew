---
import { getEntry, render } from 'astro:content';
import BaseLayout from '../../layouts/BaseLayout.astro';
import Breadcrumbs from '../../components/Breadcrumbs.astro';
import AnswerBox from '../../components/AnswerBox.astro';
import Disclaimer from '../../components/Disclaimer.astro';
import FAQSection from '../../components/FAQSection.astro';
import LastUpdated from '../../components/LastUpdated.astro';
import AuthorBio from '../../components/AuthorBio.astro';
import SourcesBox from '../../components/SourcesBox.astro';
import { getBreadcrumbSchema, getArticleSchema, getFAQSchema, getSoftwareApplicationSchema } from '../../lib/schema';
import metalTiers from '../../data/metal-tiers.json';

const entry = await getEntry('tools', 'plan-comparison');
const { Content } = await render(entry);
const { title, description, datePublished, dateModified, faqs } = entry.data;

const breadcrumbs = [
  { name: 'Home', url: '/' },
  { name: 'Tools', url: '/tools' },
  { name: 'Plan Comparison', url: '/tools/plan-comparison' },
];

const schemas = [
  getBreadcrumbSchema(breadcrumbs),
  getArticleSchema({ title, description, url: '/tools/plan-comparison', datePublished, dateModified }),
  getSoftwareApplicationSchema({ name: title, description, url: '/tools/plan-comparison' }),
  ...(faqs?.length ? [getFAQSchema(faqs)] : []),
].filter(Boolean);
---

<BaseLayout title={title} description={description} schemas={schemas}>
  <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 py-10">
    <Breadcrumbs items={breadcrumbs} />

    <h1 class="text-3xl sm:text-4xl font-bold text-neutral-900 leading-heading mb-4">{title}</h1>

    <AnswerBox answer="ACA marketplace plans come in four metal tiers -- Bronze, Silver, Gold, and Platinum -- each offering a different balance of monthly premiums and out-of-pocket costs. Select a usage level to see which tier may be a good starting point." />

    <Disclaimer variant="tool" />

    <div class="bg-neutral-50 border border-neutral-200 rounded-lg p-4 mb-6">
      <p class="text-sm text-neutral-600 leading-relaxed">
        This website is not affiliated with any federal or state government agency. Information provided here is for educational purposes only.
      </p>
    </div>

    <!-- Calculator UI -->
    <div class="bg-white rounded-xl border border-neutral-200 p-6 shadow-sm mb-8">
      <h2 class="text-xl font-semibold text-neutral-800 mb-2">Metal Tier Comparison Tool</h2>
      <p class="text-sm text-neutral-600 mb-5">
        Select your expected healthcare usage level to see how the four metal tiers compare and which tier may be a reasonable starting point based on general guidelines.
      </p>

      <!-- Usage Level Selector -->
      <div class="mb-6">
        <p class="text-sm font-medium text-neutral-700 mb-3">Expected Healthcare Usage Level</p>
        <div class="flex flex-wrap gap-3">
          <button
            type="button"
            data-usage="low"
            class="usage-btn px-6 py-2.5 rounded-lg border border-neutral-300 text-neutral-700 font-medium hover:bg-neutral-50 transition-colors"
          >
            Low Usage
          </button>
          <button
            type="button"
            data-usage="moderate"
            class="usage-btn px-6 py-2.5 rounded-lg border border-neutral-300 text-neutral-700 font-medium hover:bg-neutral-50 transition-colors"
          >
            Moderate Usage
          </button>
          <button
            type="button"
            data-usage="high"
            class="usage-btn px-6 py-2.5 rounded-lg border border-neutral-300 text-neutral-700 font-medium hover:bg-neutral-50 transition-colors"
          >
            High Usage
          </button>
        </div>
        <div class="mt-2 text-xs text-neutral-500">
          <span class="block"><strong>Low:</strong> Rarely visit doctors, no ongoing prescriptions, mainly want coverage for unexpected events.</span>
          <span class="block"><strong>Moderate:</strong> Regular checkups, a few prescriptions, occasional specialist visits.</span>
          <span class="block"><strong>High:</strong> Frequent doctor visits, multiple prescriptions, ongoing treatments or planned procedures.</span>
        </div>
      </div>

      <!-- Tier Comparison Cards -->
      <div id="tier-cards" class="hidden">
        <h3 class="text-lg font-semibold text-neutral-800 mb-4">Plan Tier Comparison</h3>

        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mb-6" id="cards-container">
          <!-- Cards rendered by JS -->
        </div>

        <div id="recommendation" class="bg-primary-50 border border-primary-200 rounded-lg p-4 mb-4">
          <p class="text-sm font-semibold text-primary-700 mb-1">Educational Suggestion</p>
          <p id="recommendation-text" class="text-sm text-primary-800 leading-relaxed">--</p>
        </div>

        <p class="text-xs text-neutral-500 mt-4">
          This comparison is for educational purposes only. Actual plan costs, benefits, and availability vary by location, insurer, and enrollment period. The suggestion above is a general starting point, not a recommendation for any specific plan. Consider all factors including available cost-sharing reductions for Silver plans.
        </p>
      </div>
    </div>

    <!-- Content from collection -->
    <div class="prose prose-neutral max-w-none mb-8">
      <Content />
    </div>

    <LastUpdated date={dateModified} />

    {faqs?.length > 0 && <FAQSection faqs={faqs} />}

    <SourcesBox sources={[
      { title: 'Healthcare.gov - Plan Categories', url: 'https://www.healthcare.gov/choose-a-plan/plans-categories/' },
      { title: 'Healthcare.gov - Cost-Sharing Reductions', url: 'https://www.healthcare.gov/lower-costs/save-on-out-of-pocket-costs/' },
      { title: 'CMS - Actuarial Value and Cost Sharing', url: 'https://www.cms.gov/cciio/resources/data-resources/marketplace-puf' },
    ]} />

    <AuthorBio />
  </div>
</BaseLayout>

<script define:vars={{ tiers: metalTiers.tiers }}>
  document.addEventListener('DOMContentLoaded', function () {
    var tierCards = document.getElementById('tier-cards');
    var cardsContainer = document.getElementById('cards-container');
    var recommendationText = document.getElementById('recommendation-text');
    var usageButtons = document.querySelectorAll('.usage-btn');
    var selectedUsage = null;

    var tierColors = {
      bronze: { bg: 'bg-amber-50', border: 'border-amber-300', accent: 'text-amber-700', ring: 'ring-amber-400' },
      silver: { bg: 'bg-slate-50', border: 'border-slate-300', accent: 'text-slate-700', ring: 'ring-slate-400' },
      gold: { bg: 'bg-yellow-50', border: 'border-yellow-400', accent: 'text-yellow-700', ring: 'ring-yellow-400' },
      platinum: { bg: 'bg-indigo-50', border: 'border-indigo-300', accent: 'text-indigo-700', ring: 'ring-indigo-400' },
    };

    var usageToTier = {
      low: 'bronze',
      moderate: 'silver',
      high: 'gold',
    };

    var recommendations = {
      low: 'Based on low expected healthcare usage, a Bronze plan may be a reasonable starting point. Bronze plans typically have the lowest monthly premiums, which can be appealing for generally healthy individuals who mainly want coverage for unexpected medical events. Keep in mind that out-of-pocket costs are higher when care is needed.',
      moderate: 'Based on moderate expected healthcare usage, a Silver plan may be a reasonable starting point. Silver plans offer a balance between monthly premiums and out-of-pocket costs. An important consideration: cost-sharing reductions (CSRs) are available only with Silver plans for eligible lower-income households, which can significantly reduce deductibles and copays.',
      high: 'Based on high expected healthcare usage, a Gold plan may be a reasonable starting point. Gold plans generally have higher monthly premiums but lower costs when receiving care, which can be beneficial for individuals with frequent healthcare needs. For very high usage, a Platinum plan may also be worth considering despite its higher premiums.',
    };

    function renderCards(usage) {
      var recommendedSlug = usageToTier[usage];
      cardsContainer.innerHTML = '';

      for (var i = 0; i < tiers.length; i++) {
        var tier = tiers[i];
        var colors = tierColors[tier.slug] || tierColors.bronze;
        var isRecommended = tier.slug === recommendedSlug;

        var card = document.createElement('div');
        var cardClasses = 'rounded-xl border-2 p-5 transition-all ' + colors.bg + ' ' + colors.border;
        if (isRecommended) {
          cardClasses += ' ring-2 ' + colors.ring + ' shadow-md';
        }
        card.className = cardClasses;

        var html = '';
        if (isRecommended) {
          html += '<span class="inline-block text-xs font-semibold uppercase tracking-wider px-2 py-0.5 rounded-full bg-primary-600 text-white mb-3">Suggested Starting Point</span>';
        }
        html += '<h4 class="text-lg font-bold ' + colors.accent + ' mb-2">' + tier.name + ' Plan</h4>';
        html += '<p class="text-sm text-neutral-600 mb-3">' + tier.description + '</p>';
        html += '<div class="space-y-2">';
        html += '<div class="flex justify-between text-sm"><span class="text-neutral-500">Actuarial Value</span><span class="font-semibold text-neutral-800">' + tier.actuarialValue + '%</span></div>';
        html += '<div class="flex justify-between text-sm"><span class="text-neutral-500">Premium Level</span><span class="font-semibold text-neutral-800">' + tier.premiumLevel + '</span></div>';
        html += '<div class="flex justify-between text-sm"><span class="text-neutral-500">Out-of-Pocket Level</span><span class="font-semibold text-neutral-800">' + tier.outOfPocketLevel + '</span></div>';
        html += '</div>';
        html += '<div class="mt-3 pt-3 border-t ' + colors.border + '">';
        html += '<p class="text-xs text-neutral-500"><strong>Generally suited for:</strong> ' + tier.bestFor + '</p>';
        html += '</div>';

        card.innerHTML = html;
        cardsContainer.appendChild(card);
      }

      recommendationText.textContent = recommendations[usage];
      tierCards.classList.remove('hidden');
    }

    for (var i = 0; i < usageButtons.length; i++) {
      usageButtons[i].addEventListener('click', function () {
        var usage = this.getAttribute('data-usage');
        selectedUsage = usage;

        // Update button styles
        for (var j = 0; j < usageButtons.length; j++) {
          usageButtons[j].className = 'usage-btn px-6 py-2.5 rounded-lg border border-neutral-300 text-neutral-700 font-medium hover:bg-neutral-50 transition-colors';
        }
        this.className = 'usage-btn px-6 py-2.5 rounded-lg bg-primary-600 text-white font-medium hover:bg-primary-700 transition-colors';

        renderCards(usage);
      });
    }
  });
</script>
