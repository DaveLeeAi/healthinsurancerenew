---
import { getEntry, render } from 'astro:content';
import BaseLayout from '../../layouts/BaseLayout.astro';
import Breadcrumbs from '../../components/Breadcrumbs.astro';
import AnswerBox from '../../components/AnswerBox.astro';
import Disclaimer from '../../components/Disclaimer.astro';
import FAQSection from '../../components/FAQSection.astro';
import LastUpdated from '../../components/LastUpdated.astro';
import AuthorBio from '../../components/AuthorBio.astro';
import SourcesBox from '../../components/SourcesBox.astro';
import { getBreadcrumbSchema, getArticleSchema, getFAQSchema, getSoftwareApplicationSchema } from '../../lib/schema';
import fplData from '../../data/fpl-current.json';
import csrData from '../../data/csr-tiers.json';

const entry = await getEntry('tools', 'csr-estimator');
const { Content } = await render(entry);
const { title, description, datePublished, dateModified, faqs } = entry.data;

const breadcrumbs = [
  { name: 'Home', url: '/' },
  { name: 'Tools', url: '/tools' },
  { name: 'CSR Estimator', url: '/tools/csr-estimator' },
];

const schemas = [
  getBreadcrumbSchema(breadcrumbs),
  getArticleSchema({ title, description, url: '/tools/csr-estimator', datePublished, dateModified }),
  getSoftwareApplicationSchema({ name: title, description, url: '/tools/csr-estimator' }),
  ...(faqs?.length ? [getFAQSchema(faqs)] : []),
].filter(Boolean);
---

<BaseLayout title={title} description={description} schemas={schemas}>
  <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 py-10">
    <Breadcrumbs items={breadcrumbs} />

    <h1 class="text-3xl sm:text-4xl font-bold text-slate-900 leading-heading mb-4">{title}</h1>

    <AnswerBox answer="Enter your household size and income to estimate whether you may qualify for cost-sharing reductions that lower deductibles, copays, and out-of-pocket maximums on Silver marketplace plans." />

    <Disclaimer variant="tool" />

    <div class="bg-white/70 backdrop-blur-sm border border-slate-200/80 rounded-2xl p-4 mb-6">
      <p class="text-sm text-slate-600 leading-relaxed">
        This website is not affiliated with any federal or state government agency. Information provided here is for educational purposes only.
      </p>
    </div>

    <div class="bg-white/70 backdrop-blur-sm rounded-2xl border border-slate-200/80 p-6 shadow-lg mb-8">
      <h2 class="text-xl font-semibold text-slate-800 mb-2">Cost-Sharing Reduction Estimator</h2>
      <p class="text-sm text-slate-600 mb-5">
        CSRs are available only on Silver plans and reduce deductibles, copays, and out-of-pocket maximums for households with income between 100% and 250% of the Federal Poverty Level.
      </p>

      <form id="csr-form" class="space-y-5">
        <div>
          <label for="household-size" class="block text-sm font-medium text-slate-700 mb-1">Household Size</label>
          <select
            id="household-size"
            class="w-full rounded-lg border border-slate-300 px-4 py-2.5 text-sm focus:ring-2 focus:ring-primary-500 focus:border-primary-500 outline-none"
          >
            <option value="">Select household size</option>
            <option value="1">1 person</option>
            <option value="2">2 people</option>
            <option value="3">3 people</option>
            <option value="4">4 people</option>
            <option value="5">5 people</option>
            <option value="6">6 people</option>
            <option value="7">7 people</option>
            <option value="8">8 people</option>
          </select>
        </div>

        <div>
          <label for="annual-income" class="block text-sm font-medium text-slate-700 mb-1">Annual Household Income ($)</label>
          <input
            type="number"
            id="annual-income"
            placeholder="e.g. 28000"
            min="0"
            step="100"
            class="w-full rounded-lg border border-slate-300 px-4 py-2.5 text-sm focus:ring-2 focus:ring-primary-500 focus:border-primary-500 outline-none"
          />
        </div>

        <div id="form-error" class="hidden rounded-lg bg-error-50 border border-error-200 px-4 py-2.5 text-sm text-error-700" role="alert" aria-live="polite"></div>

        <div class="flex gap-3">
          <button
            type="submit"
            class="px-6 py-2.5 rounded-xl bg-navy-900 text-white font-medium hover:bg-navy-800 transition-colors"
          >
            Check CSR Eligibility
          </button>
          <button
            type="button"
            id="reset-btn"
            class="px-6 py-2.5 rounded-lg border border-slate-300 text-slate-700 font-medium hover:bg-slate-50 transition-colors"
          >
            Reset
          </button>
        </div>
      </form>

      <div id="results" class="hidden mt-6 border-t border-slate-200 pt-6">
        <h3 class="text-lg font-semibold text-slate-800 mb-4">Educational Estimate</h3>

        <div class="grid grid-cols-1 sm:grid-cols-3 gap-4 mb-4">
          <div class="bg-primary-50/80 backdrop-blur-sm rounded-xl p-4">
            <p class="text-sm text-slate-600 font-medium">Federal Poverty Level</p>
            <p id="result-fpl" class="text-xl font-bold text-slate-900 mt-1">--</p>
          </div>
          <div class="bg-primary-50/80 backdrop-blur-sm rounded-xl p-4">
            <p class="text-sm text-slate-600 font-medium">Income as % of FPL</p>
            <p id="result-fpl-percent" class="text-xl font-bold text-slate-900 mt-1">--</p>
          </div>
          <div class="bg-primary-50/80 backdrop-blur-sm rounded-xl p-4">
            <p class="text-sm text-slate-600 font-medium">CSR Tier</p>
            <p id="result-csr-tier" class="text-xl font-bold text-slate-900 mt-1">--</p>
          </div>
        </div>

        <div id="csr-comparison" class="hidden mb-4">
          <h4 class="text-base font-semibold text-slate-800 mb-3">Your Enhanced Silver Plan vs. Standard Silver</h4>
          <div class="overflow-x-auto">
            <table class="w-full text-sm border-collapse">
              <thead>
                <tr class="bg-slate-50">
                  <th class="text-left px-4 py-2.5 font-medium text-slate-700 border-b border-slate-200">Cost Category</th>
                  <th class="text-right px-4 py-2.5 font-medium text-slate-700 border-b border-slate-200">Your Enhanced Silver</th>
                  <th class="text-right px-4 py-2.5 font-medium text-slate-700 border-b border-slate-200">Standard Silver</th>
                </tr>
              </thead>
              <tbody>
                <tr>
                  <td class="px-4 py-2.5 text-slate-700 border-b border-slate-100">Annual Deductible</td>
                  <td id="td-deductible-csr" class="text-right px-4 py-2.5 font-semibold text-green-700 border-b border-slate-100">--</td>
                  <td id="td-deductible-std" class="text-right px-4 py-2.5 text-slate-500 border-b border-slate-100">--</td>
                </tr>
                <tr>
                  <td class="px-4 py-2.5 text-slate-700 border-b border-slate-100">Out-of-Pocket Max</td>
                  <td id="td-oop-csr" class="text-right px-4 py-2.5 font-semibold text-green-700 border-b border-slate-100">--</td>
                  <td id="td-oop-std" class="text-right px-4 py-2.5 text-slate-500 border-b border-slate-100">--</td>
                </tr>
                <tr>
                  <td class="px-4 py-2.5 text-slate-700 border-b border-slate-100">Primary Care Copay</td>
                  <td id="td-copay-csr" class="text-right px-4 py-2.5 font-semibold text-green-700 border-b border-slate-100">--</td>
                  <td id="td-copay-std" class="text-right px-4 py-2.5 text-slate-500 border-b border-slate-100">--</td>
                </tr>
                <tr>
                  <td class="px-4 py-2.5 text-slate-700 border-b border-slate-100">Specialist Copay</td>
                  <td id="td-spec-csr" class="text-right px-4 py-2.5 font-semibold text-green-700 border-b border-slate-100">--</td>
                  <td id="td-spec-std" class="text-right px-4 py-2.5 text-slate-500 border-b border-slate-100">--</td>
                </tr>
                <tr>
                  <td class="px-4 py-2.5 text-slate-700">Generic Rx Copay</td>
                  <td id="td-rx-csr" class="text-right px-4 py-2.5 font-semibold text-green-700">--</td>
                  <td id="td-rx-std" class="text-right px-4 py-2.5 text-slate-500">--</td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>

        <div id="result-determination" class="rounded-lg p-4 mb-4">
          <p id="determination-title" class="font-semibold text-lg mb-1">--</p>
          <p id="determination-text" class="text-sm leading-relaxed">--</p>
        </div>

        <p class="text-xs text-slate-500 mt-4">
          This is a general educational estimate. Actual CSR eligibility and benefit levels are determined by the Health Insurance Marketplace based on verified income and household information. Copay and deductible amounts shown are approximate national averages and vary by plan and insurer.
        </p>
      </div>
    </div>

    <div class="prose prose-neutral max-w-none mb-8 prose-headings:font-bold prose-headings:text-slate-900 prose-a:text-primary-600 hover:prose-a:text-primary-800 font-serif">
      <Content />
    </div>

    <LastUpdated date={dateModified} />

    {faqs?.length > 0 && <FAQSection faqs={faqs} />}

    <SourcesBox sources={[
      { title: 'Healthcare.gov - Cost-Sharing Reductions', url: 'https://www.healthcare.gov/glossary/cost-sharing-reduction/' },
      { title: 'CMS - Actuarial Value and Cost-Sharing', url: 'https://www.cms.gov/cciio/resources/data-resources/marketplace-puf' },
      { title: 'HHS Poverty Guidelines', url: 'https://aspe.hhs.gov/topics/poverty-economic-mobility/poverty-guidelines' },
    ]} />

    <AuthorBio />
  </div>
</BaseLayout>

<script define:vars={{ fplData, csrData }}>
  document.addEventListener('DOMContentLoaded', function () {
    var form = document.getElementById('csr-form');
    var resultsDiv = document.getElementById('results');
    var resetBtn = document.getElementById('reset-btn');
    var errorDiv = document.getElementById('form-error');

    var standardTier = csrData.tiers[csrData.tiers.length - 1];

    function showError(msg) {
      errorDiv.textContent = msg;
      errorDiv.classList.remove('hidden');
    }

    function hideError() {
      errorDiv.classList.add('hidden');
    }

    function getFPL(size) {
      if (size <= 6) {
        return fplData.guidelines['household_' + size];
      }
      return fplData.guidelines['household_6'] + fplData.guidelines.additionalPerson * (size - 6);
    }

    function findCSRTier(fplPercent) {
      for (var i = 0; i < csrData.tiers.length; i++) {
        var tier = csrData.tiers[i];
        if (fplPercent >= tier.minFPL && fplPercent < tier.maxFPL) {
          return tier;
        }
      }
      return null;
    }

    function fmt(n) {
      return '$' + n.toLocaleString();
    }

    form.addEventListener('submit', function (e) {
      e.preventDefault();
      hideError();

      var sizeVal = document.getElementById('household-size').value;
      var incomeVal = document.getElementById('annual-income').value;

      if (!sizeVal || !incomeVal) {
        showError('Please complete all fields before calculating.');
        return;
      }

      var size = parseInt(sizeVal, 10);
      var income = parseFloat(incomeVal);

      if (income <= 0) {
        showError('Please enter a valid income amount greater than zero.');
        return;
      }

      var fpl = getFPL(size);
      var fplPercent = (income / fpl) * 100;

      document.getElementById('result-fpl').textContent = fmt(fpl);
      document.getElementById('result-fpl-percent').textContent = fplPercent.toFixed(0) + '%';

      var tier = findCSRTier(fplPercent);
      var compDiv = document.getElementById('csr-comparison');
      var detDiv = document.getElementById('result-determination');
      var detTitle = document.getElementById('determination-title');
      var detText = document.getElementById('determination-text');

      if (fplPercent < 100) {
        document.getElementById('result-csr-tier').textContent = 'Below 100% FPL';
        compDiv.classList.add('hidden');
        detDiv.className = 'rounded-lg p-4 mb-4 bg-amber-50 border border-amber-200';
        detTitle.className = 'font-semibold text-lg mb-1 text-amber-800';
        detTitle.textContent = 'Income may be below marketplace eligibility';
        detText.className = 'text-sm leading-relaxed text-amber-700';
        detText.textContent = 'At income below 100% of the Federal Poverty Level, individuals may qualify for Medicaid in states that have expanded eligibility. In states without Medicaid expansion, other options may be available. Marketplace subsidies generally require income at or above 100% FPL.';
      } else if (tier && tier.name !== 'Standard Silver') {
        document.getElementById('result-csr-tier').textContent = tier.name;
        compDiv.classList.remove('hidden');

        document.getElementById('td-deductible-csr').textContent = fmt(tier.deductible);
        document.getElementById('td-deductible-std').textContent = fmt(standardTier.deductible);
        document.getElementById('td-oop-csr').textContent = fmt(tier.oopMax);
        document.getElementById('td-oop-std').textContent = fmt(standardTier.oopMax);
        document.getElementById('td-copay-csr').textContent = fmt(tier.copayPrimary);
        document.getElementById('td-copay-std').textContent = fmt(standardTier.copayPrimary);
        document.getElementById('td-spec-csr').textContent = fmt(tier.copaySpecialist);
        document.getElementById('td-spec-std').textContent = fmt(standardTier.copaySpecialist);
        document.getElementById('td-rx-csr').textContent = fmt(tier.copayGenericRx);
        document.getElementById('td-rx-std').textContent = fmt(standardTier.copayGenericRx);

        var savings = standardTier.oopMax - tier.oopMax;
        detDiv.className = 'rounded-lg p-4 mb-4 bg-green-50 border border-green-200';
        detTitle.className = 'font-semibold text-lg mb-1 text-green-800';
        detTitle.textContent = 'You may qualify for ' + tier.name + ' cost-sharing reductions';
        detText.className = 'text-sm leading-relaxed text-green-700';
        detText.textContent = 'At ' + fplPercent.toFixed(0) + '% of the Federal Poverty Level, a Silver plan with CSR benefits could reduce the out-of-pocket maximum by approximately ' + fmt(savings) + ' compared to a standard Silver plan. This means lower deductibles, copays, and maximum annual spending. CSR benefits are only available when selecting a Silver-tier plan on the marketplace.';
      } else {
        document.getElementById('result-csr-tier').textContent = 'Not CSR Eligible';
        compDiv.classList.add('hidden');
        detDiv.className = 'rounded-lg p-4 mb-4 bg-primary-50 border border-primary-200';
        detTitle.className = 'font-semibold text-lg mb-1 text-primary-800';
        detTitle.textContent = 'Standard Silver plan (no additional cost-sharing reductions)';
        detText.className = 'text-sm leading-relaxed text-primary-700';
        detText.textContent = 'At ' + fplPercent.toFixed(0) + '% of the Federal Poverty Level, income exceeds the CSR threshold of 250% FPL. While cost-sharing reductions would not apply, premium tax credits may still be available to reduce monthly plan costs. All metal tiers remain available.';
      }

      resultsDiv.classList.remove('hidden');
    });

    resetBtn.addEventListener('click', function () {
      form.reset();
      resultsDiv.classList.add('hidden');
      hideError();
    });
  });
</script>
